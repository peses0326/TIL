# 2. 운영 서버 환경의 구성
#TIL/aws

[AWS 인프라 구축 가이드](http://www.yes24.com/Product/Goods/68799454)

---

### 운영 서버 아키텍처의 이해

- 단일 서버 : 하나의 서버에 애플리케이션과 데이터베이스가 함께 있는 구조
  - 전체 서비스에 장애가 생길 확률이 높다.
  - 서버 자원을 효율적으로 이용할 수 없다.
  - 보안성이 떨어진다. (웹 애플리케이션 특성상 다양한 IP, 포트번호에서 요청을 받을 수 있어야 하기 때문)
  - 스케일 아웃이 힘들다.

- 애플리케이션/데이터베이스 서버 분리
  - 전체 서비스 장애 방지, 효율적인 자원 사용, 보안성 향상
  - 하지만 여전히 스케일 아웃은 힘들다. (클라이언트가 보고 있는 서버는 하나다.)

- 서버 단위의 로드 밸런서
  - 스케일 아웃이 가능해졌다.
  - 로드 밸런서가 장애나면 전체 서비스 장애로 이어질 수 있다.
  - OSI 7 레이어의 L4 스위치

- 서버 내 앱 단위의 로드 밸런서
  - 애플리케이션 프로세스들에 요청을 분산시키는 앱 단위의 로드 밸런서
  - 하나의 서버에서 여러 개의 요청 처리 / 여러 프로세스로 서버 자원 최대한 활용

### EC2

- AMI : EC2 인스턴스의 기반이 되는 이미지
  - 같은 OS여도 해당 OS의 특정 버전 자바처럼 원하는 환경 구성 후 이미지로 만들어서 재사용, 공유할 수도 있다.
- 보안 그룹 : 보안을 위해 IP와 포트 번호를 이용해 정의해두는 서버 접속 규칙
- 키 페어 : 공개 키 암호화 기법을 사용. 서버에는 공개키, 개인에게 개인키 발급

#### [실습] nvm, git 설치 및 예제 프로젝트 내려받기

### 웹 서버와 웹 애플리케이션 서버

- WS : 클라이언트에서 HTTP 프로토콜로 요청을 받고 **정적인 파일**들을 응답으로 처리한다.  
- WAS : 클라이언트 요청에 대해 코드 실행을 통해 **동적인 응답**을 만들어주는 역할을 한다.  또한 배포한 코드를 프로세스로 실행시키고, 해당 프로세스에 요청을 넘겨주는 역할도 한다.  
- WS와 WAS는 보통 함께 사용된다. WS가 정적 파일을 처리하거나 여러 WAS로 라우팅하는 역할을 한다.  

#### [실습] WS - nginx / WAS - Phusion Passenger 설치 및 서비스

- `/var` 디렉토리는 root 계정의 소유로 되어 있고, 현재 ec2-user 계정이기 때문에 해당 디렉토리에서 하는 모든 작업은 sudo 권한이 필요하다.  
- [nginx service script · GitHub](https://gist.github.com/deopard/fe2b37c499f3e3225a99f8bc45d5be07)

#### [실습] 하나의 서버에서 두 개의 애플리케이션 서비스하기

- 하나의 서버는 하나의 IP 주소를 갖지만 도메인 주소는 여러 개를 가질 수 있다. 이 점을 이용하면 서버 내 nginx가 어떤 주소로 요청했는지를 파악하여 해당 애플리케이션으로 전달할 수 있다. 라우터의 역할을 하는 것이다.  
- nginx 설정 파일에 두 개의 server 를 지정하는데, 하나는 ec2 IP 주소, 다른 하나는 ec2 DNS 주소로 지정하면 각각의 요청에 맞게 애플리케이션이 응답을 주는 것을 볼 수 있다.
